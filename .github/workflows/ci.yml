name: Customer Support System CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  quick-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Fail if job takes more than 5 minutes
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate project structure
      run: |
        echo "ğŸ” Validating project structure..."
        [ -f "package.json" ] || { echo "âŒ package.json missing"; exit 1; }
        [ -d "backend" ] || { echo "âŒ backend directory missing"; exit 1; }
        [ -f "backend/server.js" ] || { echo "âŒ backend/server.js missing"; exit 1; }
        echo "âœ… Project structure valid"

    - name: Check syntax and dependencies
      run: |
        echo "ğŸ”§ Checking syntax and dependencies..."
        # Syntax check only - don't actually run the server
        node -c backend/server.js && echo "âœ… Server syntax valid"
        
        # Quick dependency check
        node -e "
          const required = ['express', 'mongoose', 'cors', 'bcryptjs', 'dotenv'];
          required.forEach(dep => {
            try {
              require(dep);
              console.log('âœ… ' + dep + ' available');
            } catch (e) {
              console.error('âŒ ' + dep + ' missing: ' + e.message);
              process.exit(1);
            }
          });
          console.log('âœ… All dependencies available');
        "

    - name: Quick security audit
      run: |
        echo "ğŸ”’ Running quick security check..."
        npm audit --audit-level high --production || true
        echo "âš ï¸  Dev dependencies may have vulnerabilities"

  test-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quick-validation
    
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests with timeout
      run: |
        echo "ğŸ§ª Running tests..."
        # Add timeout to prevent hanging
        timeout 300s npm test || { echo "âŒ Tests timed out or failed"; exit 1; }
      env:
        NODE_ENV: test
        MONGODB_URI: mongodb://localhost:27017/test_support_system
        JWT_SECRET: test-jwt-secret-for-ci

    - name: Test coverage
      run: |
        echo "ğŸ“Š Checking test coverage..."
        timeout 60s npm run test:coverage --if-present || echo "âš ï¸ Coverage check skipped"

  build-check:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: quick-validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Quick build verification
      run: |
        echo "ğŸ—ï¸  Verifying build..."
        # Only check if build script exists and runs without hanging
        if grep -q '"build"' package.json; then
          echo "ğŸ“¦ Build script found, testing..."
          timeout 30s npm run build --if-present && echo "âœ… Build successful" || echo "âš ï¸ Build skipped or failed"
        else
          echo "â„¹ï¸  No build script found"
        fi